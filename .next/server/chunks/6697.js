exports.id=6697,exports.ids=[6697],exports.modules={2507:(a,b,c)=>{"use strict";c.d(b,{R:()=>g,U:()=>f});var d=c(38151),e=c(44999);async function f(){let a=await (0,e.UL)();return(0,d.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{getAll:()=>a.getAll(),setAll(b){try{b.forEach(({name:b,value:c,options:d})=>a.set(b,c,d))}catch{}}}})}let g=f},54756:(a,b,c)=>{"use strict";c.d(b,{$x:()=>k,CJ:()=>t,Cs:()=>o,ET:()=>m,IZ:()=>q,KC:()=>r,TE:()=>n,Vd:()=>l,gJ:()=>u,id:()=>v,oY:()=>p,wx:()=>j,yH:()=>s});var d=c(67218);c(79130);var e=c(2507),f=c(75661),g=c(62351);async function h(){let a=await (0,e.R)(),{data:{user:b}}=await a.auth.getUser();if(!b||!(0,f.qc)(b.email))throw Error("Acesso negado: apenas administradores");return{supabase:a,adminId:b.id,adminEmail:b.email}}async function i(a,b,c,d,e){await a.from("admin_logs").insert({admin_id:b,acao:c,descricao:d,metadata:e||null})}async function j(){let{supabase:a,adminId:b}=await h(),c=new Date;c.setDate(1),c.setHours(0,0,0,0);let{data:d}=await a.from("transacoes_assinatura").select("valor").in("tipo",["assinatura_comprada","assinatura_renovada"]).gte("data",c.toISOString()),e=d?.reduce((a,b)=>a+Number(b.valor),0)||0,g=new Date;g.setMonth(0,1),g.setHours(0,0,0,0);let{data:j}=await a.from("transacoes_assinatura").select("valor").in("tipo",["assinatura_comprada","assinatura_renovada"]).gte("data",g.toISOString()),k=j?.reduce((a,b)=>a+Number(b.valor),0)||0,{data:l}=await a.from("transacoes_assinatura").select("valor").in("tipo",["assinatura_comprada","assinatura_renovada"]),m=l?.reduce((a,b)=>a+Number(b.valor),0)||0,{count:n}=await a.from("assinaturas").select("*",{count:"exact",head:!0}).eq("status","ativa"),{data:o}=await a.from("assinaturas").select("user_id").eq("status","ativa"),p=new Set(o?.map(a=>a.user_id)).size,{data:q}=await a.from("transacoes_assinatura").select("data, valor").in("tipo",["assinatura_comprada","assinatura_renovada"]).gte("data",new Date(Date.now()-31536e6).toISOString()).order("data",{ascending:!0}),r=new Map;q?.forEach(a=>{let b=new Date(a.data).toISOString().substring(0,7);r.set(b,(r.get(b)||0)+Number(a.valor))});let s=Array.from(r.entries()).map(([a,b])=>({mes:a,valor:b})).sort((a,b)=>a.mes.localeCompare(b.mes));return await i(a,b,f.Oe.ACESSO_PAINEL,"Visualizou dashboard"),{totalMesAtual:e,totalAno:k,totalGeral:m,assinaturasAtivas:n||0,usuariosAtivos:p,faturamentoMensal:s}}async function k(a){let{supabase:b}=await h(),c=b.from("assinaturas").select(`
      *,
      usuarios_perfil(nome)
    `).order("data_fim",{ascending:!0});a?.status&&(c=c.eq("status",a.status)),a?.plano&&(c=c.eq("plano",a.plano));let{data:d,error:e}=await c;if(e)throw e;d?.map(a=>a.user_id);let{data:f}=await b.auth.admin.listUsers(),g=new Map(f?.users.map(a=>[a.id,a.email]));return(d||[]).map(a=>({...a,email:g.get(a.user_id),nome:a.usuarios_perfil?.nome,dias_restantes:Math.max(0,Math.ceil((new Date(a.data_fim).getTime()-Date.now())/864e5))}))}async function l(a){let{supabase:b,adminId:c}=await h(),{data:d}=await b.auth.admin.listUsers(),e=d?.users.find(b=>b.email===a.userEmail);if(!e)throw Error("Usu\xe1rio n\xe3o encontrado");let j=new Date,k=new Date;k.setMonth(k.getMonth()+a.meses);let{data:l,error:m}=await b.from("assinaturas").insert({user_id:e.id,plano:a.plano,status:"ativa",data_inicio:j.toISOString(),data_fim:k.toISOString(),renova_automaticamente:a.renovaAutomaticamente||!1,valor_mensal:a.valorMensal}).select().single();if(m)throw m;return await b.from("transacoes_assinatura").insert({user_id:e.id,assinatura_id:l.id,valor:a.valorMensal*a.meses,tipo:"assinatura_comprada",descricao:`Assinatura ${a.plano} - ${a.meses} m\xeas(es)`}),await i(b,c,f.Oe.CRIAR_ASSINATURA,`Criou assinatura ${a.plano} para ${a.userEmail}`,{assinatura_id:l.id,plano:a.plano,meses:a.meses}),(0,g.revalidatePath)("/admin"),{success:!0,assinatura:l}}async function m(a){let{supabase:b,adminId:c}=await h(),{data:d}=await b.auth.admin.listUsers(),e=d?.users.find(b=>b.email===a.userEmail);if(!e)throw Error("Usu\xe1rio n\xe3o encontrado");let j=new Date,k=new Date;k.setMonth(k.getMonth()+a.meses);let{data:l,error:m}=await b.from("assinaturas").insert({user_id:e.id,plano:a.plano,status:"ativa",data_inicio:j.toISOString(),data_fim:k.toISOString(),renova_automaticamente:!1,valor_mensal:0}).select().single();if(m)throw m;return await b.from("transacoes_assinatura").insert({user_id:e.id,assinatura_id:l.id,valor:0,tipo:"assinatura_doada",descricao:`Assinatura ${a.plano} doada - ${a.meses} m\xeas(es)`}),await i(b,c,f.Oe.DOAR_ASSINATURA,`Doou ${a.meses} m\xeas(es) de ${a.plano} para ${a.userEmail}`,{assinatura_id:l.id}),(0,g.revalidatePath)("/admin"),{success:!0}}async function n(a){let{supabase:b,adminId:c}=await h(),{data:d}=await b.from("assinaturas").select("*, usuarios_perfil(nome)").eq("id",a).single();if(!d)throw Error("Assinatura n\xe3o encontrada");return await b.from("assinaturas").update({status:"cancelada",renova_automaticamente:!1}).eq("id",a),await b.from("transacoes_assinatura").insert({user_id:d.user_id,assinatura_id:a,valor:0,tipo:"assinatura_cancelada",descricao:`Assinatura ${d.plano} cancelada pelo admin`}),await i(b,c,f.Oe.CANCELAR_ASSINATURA,`Cancelou assinatura ${d.plano}`,{assinatura_id:a}),(0,g.revalidatePath)("/admin"),{success:!0}}async function o(a,b){let{supabase:c,adminId:d}=await h(),{data:e}=await c.from("assinaturas").select("*").eq("id",a).single();if(!e)throw Error("Assinatura n\xe3o encontrada");let j=new Date(e.data_fim);return j.setMonth(j.getMonth()+b),await c.from("assinaturas").update({data_fim:j.toISOString(),status:"ativa"}).eq("id",a),await c.from("transacoes_assinatura").insert({user_id:e.user_id,assinatura_id:a,valor:0,tipo:"ajuste_manual",descricao:`Prazo estendido em ${b} m\xeas(es) pelo admin`}),await i(c,d,f.Oe.ESTENDER_ASSINATURA,`Estendeu assinatura em ${b} m\xeas(es)`,{assinatura_id:a,meses:b}),(0,g.revalidatePath)("/admin"),{success:!0}}async function p(a){let{supabase:b}=await h(),{data:c}=await b.auth.admin.listUsers(),{data:d}=await b.from("usuarios_perfil").select("*"),{data:e}=await b.from("assinaturas").select("*"),{data:f}=await b.from("transacoes_assinatura").select("*"),g=new Map(d?.map(a=>[a.user_id,a])),i=new Map,j=new Map;e?.forEach(a=>{i.has(a.user_id)||i.set(a.user_id,[]),i.get(a.user_id).push(a)}),f?.forEach(a=>{("assinatura_comprada"===a.tipo||"assinatura_renovada"===a.tipo)&&j.set(a.user_id,(j.get(a.user_id)||0)+Number(a.valor))});let k=(c?.users||[]).map(a=>{let b=g.get(a.id);return{id:a.id,email:a.email||"",nome:b?.nome,foto:b?.foto,created_at:a.created_at,assinaturas:i.get(a.id)||[],total_gasto:j.get(a.id)||0}});if(a){let b=a.toLowerCase();k=k.filter(a=>a.email.toLowerCase().includes(b)||a.nome?.toLowerCase().includes(b)||a.id.includes(b))}return k}async function q(a){let{supabase:b}=await h(),c=b.from("transacoes_assinatura").select("*").order("data",{ascending:!1});a?.tipo&&(c=c.eq("tipo",a.tipo)),a?.userId&&(c=c.eq("user_id",a.userId));let{data:d}=await c,{data:e}=await b.auth.admin.listUsers(),f=new Map(e?.users.map(a=>[a.id,a.email])),g=(d||[]).map(a=>({...a,email:f.get(a.user_id)}));return a?.mesAno&&(g=g.filter(b=>b.data.startsWith(a.mesAno))),g}async function r(a){let{supabase:b,adminId:c}=await h(),d="";if("assinaturas"===a){let a=await k();d="ID,Email,Nome,Plano,Status,Data In\xedcio,Data Fim,Valor Mensal,Dias Restantes\n",a.forEach(a=>{d+=`${a.id},${a.email},${a.nome||""},${a.plano},${a.status},${a.data_inicio},${a.data_fim},${a.valor_mensal},${a.dias_restantes}
`})}else if("transacoes"===a){let a=await q();d="ID,Email,Tipo,Valor,Descri\xe7\xe3o,Data\n",a.forEach(a=>{d+=`${a.id},${a.email},${a.tipo},${a.valor},"${a.descricao}",${a.data}
`})}else if("usuarios"===a){let a=await p();d="ID,Email,Nome,Total Gasto,Assinaturas Ativas,Data Cadastro\n",a.forEach(a=>{let b=a.assinaturas?.filter(a=>"ativa"===a.status).length||0;d+=`${a.id},${a.email},${a.nome||""},${a.total_gasto},${b},${a.created_at}
`})}return await i(b,c,f.Oe.EXPORTAR_CSV,`Exportou CSV de ${a}`),d}async function s(){let{supabase:a}=await h();return(await p()).filter(a=>a.total_gasto>0).sort((a,b)=>b.total_gasto-a.total_gasto).slice(0,10)}async function t(){let{supabase:a}=await h(),{data:b}=await a.from("planos").select("*").order("valor_mensal",{ascending:!0});return b||[]}async function u(a){let{supabase:b,adminId:c}=await h(),{error:d}=await b.from("planos").insert({nome:a.nome,descricao:a.descricao,valor_mensal:a.valorMensal,duracao_meses:a.duracaoMeses,beneficios:a.beneficios,ativo:!0});if(d)throw d;return await i(b,c,f.Oe.CRIAR_PLANO,`Criou plano ${a.nome}`),(0,g.revalidatePath)("/admin"),{success:!0}}async function v(a,b){let{supabase:c,adminId:d}=await h(),e={updated_at:new Date().toISOString()};b.nome&&(e.nome=b.nome),b.descricao&&(e.descricao=b.descricao),b.valorMensal&&(e.valor_mensal=b.valorMensal),b.duracaoMeses&&(e.duracao_meses=b.duracaoMeses),b.beneficios&&(e.beneficios=b.beneficios),void 0!==b.ativo&&(e.ativo=b.ativo);let{error:j}=await c.from("planos").update(e).eq("id",a);if(j)throw j;return await i(c,d,f.Oe.EDITAR_PLANO,`Atualizou plano ${b.nome||a}`),(0,g.revalidatePath)("/admin"),{success:!0}}(0,c(17478).D)([j,k,l,m,n,o,p,q,r,s,t,u,v]),(0,d.A)(j,"00c57c046824982e7c6564eea72b275b09cfb52d69",null),(0,d.A)(k,"409cb0a5d4fc4f77cc99bc679dc8298c2abfa45630",null),(0,d.A)(l,"4063e3d3de232aed4acc14293989ca8c6f14768654",null),(0,d.A)(m,"40a9dff66305a6c2364ee68171f986f693002e09b0",null),(0,d.A)(n,"4016a265ac85de23c0176e567d0d28701edc529241",null),(0,d.A)(o,"60c69f5656e7eeae6a50e1681b3207cbd64fa2a5ab",null),(0,d.A)(p,"40e7c6adf7618c55d08abd9feb78ed9425195cf3e3",null),(0,d.A)(q,"403f2f5679e42b64d083fb44b79faa52c9da6b7dd6",null),(0,d.A)(r,"4092c09dde3123b8549208155fab1f992b3758367d",null),(0,d.A)(s,"00cc92498e0ea2729fe77ff36b9d96790a599fa1a6",null),(0,d.A)(t,"00b8d46e295670804c7ea3a341c08e5bb3b85aa405",null),(0,d.A)(u,"40889cfcea5f0e1bae92f8f3df923c9479239c0acb",null),(0,d.A)(v,"6041eb3336a2ccc8ef7c11816e82e8a00136b7b97c",null)},75661:(a,b,c)=>{"use strict";c.d(b,{Oe:()=>f,qc:()=>e});let d={adminEmail:"seu-email@exemplo.com"};function e(a){return!!a&&a.toLowerCase()===d.adminEmail.toLowerCase()}let f={CRIAR_ASSINATURA:"criar_assinatura",CANCELAR_ASSINATURA:"cancelar_assinatura",ALTERAR_PLANO:"alterar_plano",DOAR_ASSINATURA:"doar_assinatura",ESTENDER_ASSINATURA:"estender_assinatura",VISUALIZAR_USUARIO:"visualizar_usuario",DELETAR_USUARIO:"deletar_usuario",CRIAR_PLANO:"criar_plano",EDITAR_PLANO:"editar_plano",DESATIVAR_PLANO:"desativar_plano",GERAR_RELATORIO:"gerar_relatorio",EXPORTAR_CSV:"exportar_csv",ACESSO_PAINEL:"acesso_painel",AJUSTE_MANUAL:"ajuste_manual"}},78335:()=>{},78717:(a,b,c)=>{"use strict";c.r(b),c.d(b,{"00b8d46e295670804c7ea3a341c08e5bb3b85aa405":()=>d.CJ,"00c57c046824982e7c6564eea72b275b09cfb52d69":()=>d.wx,"00cc92498e0ea2729fe77ff36b9d96790a599fa1a6":()=>d.yH,"4016a265ac85de23c0176e567d0d28701edc529241":()=>d.TE,"403f2f5679e42b64d083fb44b79faa52c9da6b7dd6":()=>d.IZ,"4063e3d3de232aed4acc14293989ca8c6f14768654":()=>d.Vd,"40889cfcea5f0e1bae92f8f3df923c9479239c0acb":()=>d.gJ,"4092c09dde3123b8549208155fab1f992b3758367d":()=>d.KC,"409cb0a5d4fc4f77cc99bc679dc8298c2abfa45630":()=>d.$x,"40a9dff66305a6c2364ee68171f986f693002e09b0":()=>d.ET,"40e7c6adf7618c55d08abd9feb78ed9425195cf3e3":()=>d.oY,"6041eb3336a2ccc8ef7c11816e82e8a00136b7b97c":()=>d.id,"60c69f5656e7eeae6a50e1681b3207cbd64fa2a5ab":()=>d.Cs});var d=c(54756)},96487:()=>{}};